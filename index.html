<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://q2.qlogo.cn/headimg_dl?dst_uin=2726730791&amp;spec=0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcoFork 的 EdgeOne 监控大屏</title>
    <!-- Tailwind CSS for Shadcn/UI style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }
        
        /* 卡片动态效果 */
        .bg-card, .bg-white {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .bg-card:hover, .bg-white:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 8px -6px rgba(0, 0, 0, 0.1) !important;
        }

        /* 排除设置模态框和一些不应有动画的元素 */
        #settings-modal .bg-white, 
        #settings-modal .bg-card,
        .no-hover:hover {
            transform: none !important;
        }
    </style>
    <script>
        let currentConfig = {};

        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                currentConfig = await response.json();
                if (currentConfig.siteName) {
                    document.title = currentConfig.siteName;
                    const headerEl = document.getElementById('page-header');
                    if (headerEl) headerEl.innerText = currentConfig.siteName;
                }
                const useBg = currentConfig.useBackgroundImage !== false;
                applyBackground(currentConfig.backgroundImage, useBg);
                applyOpacity(currentConfig.cardOpacity);
                renderFriendLinks(currentConfig.friendLinks);

                // If backend says IP is authorized, sync to local
                if (currentConfig.isAuthorized) {
                    // We don't have the token, but we can set a dummy one to skip login UI
                    if (!localStorage.getItem('admin_token')) {
                        localStorage.setItem('admin_token', 'ip_authorized');
                    }
                } else {
                    // If not authorized by IP and no local token, clear it
                    if (localStorage.getItem('admin_token') === 'ip_authorized') {
                        localStorage.removeItem('admin_token');
                    }
                }
            } catch (err) {
                console.error("Error fetching config:", err);
            }
        }

        function applyBackground(url, useBg = true) {
            if (useBg && url) {
                document.body.style.backgroundImage = `url('${url}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                document.body.style.backgroundRepeat = 'no-repeat';
            } else {
                document.body.style.backgroundImage = '';
            }
        }

        function applyOpacity(opacity) {
            if (opacity === undefined || opacity === null) opacity = 1.0;
            
            let styleEl = document.getElementById('dynamic-opacity-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamic-opacity-style';
                document.head.appendChild(styleEl);
            }
            
            styleEl.textContent = `
                .bg-white, .bg-card {
                    background-color: rgba(255, 255, 255, ${opacity}) !important;
                }
                /* 确保设置模态框保持不透明 */
                #settings-modal .bg-white, #settings-modal .bg-card {
                    background-color: rgba(255, 255, 255, 1) !important;
                }
                
                /* 简洁模式样式 */
                body.simple-mode {
                    /* 保持背景显示 */
                }
                body.simple-mode .simple-mode-hidden {
                    display: none !important;
                }
                body.simple-mode .max-w-7xl {
                    max-width: 100% !important;
                    padding-left: 1rem;
                    padding-right: 1rem;
                }
                body.simple-mode .space-y-8 > :not(.simple-mode-hidden) {
                    margin-top: 1rem !important;
                }
            `;
        }

        function toggleSimpleMode() {
            const isSimple = document.body.classList.toggle('simple-mode');
            localStorage.setItem('simple_mode', isSimple);
            updateSimpleModeUI();
        }

        function updateSimpleModeUI() {
            const isSimple = document.body.classList.contains('simple-mode');
            const btn = document.getElementById('simple-mode-btn');
            if (btn) {
                btn.innerHTML = isSimple 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v10"/><path d="m16 9-4 4-4-4"/><path d="M20 21H4"/></svg>` // 退出图标
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>`; // 简洁图标
                btn.title = isSimple ? "退出简洁模式" : "进入简洁模式";
            }
        }

        // 页面加载时恢复简洁模式状态
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('simple_mode') === 'true') {
                document.body.classList.add('simple-mode');
            }
            updateSimpleModeUI();
        });

        function updateOpacityLabel(val) {
            const label = document.getElementById('opacity-value');
            if (label) label.innerText = val;
        }

        let tempFriendLinks = [];
        let editingFriendLinkIndex = -1;

        function renderSettingsFriendLinks() {
            const container = document.getElementById('friend-links-settings-list');
            if (!container) return;
            container.innerHTML = '';
            
            tempFriendLinks.forEach((link, index) => {
                const isEditing = index === editingFriendLinkIndex;
                const item = document.createElement('div');
                item.className = `flex items-center gap-2 p-2 rounded border transition-colors ${isEditing ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-200'}`;
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate ${isEditing ? 'text-blue-700' : ''}">${link.name}</div>
                        <div class="text-xs text-slate-500 truncate">${link.url}</div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editFriendLink(${index})" class="text-slate-400 hover:text-blue-600 p-1" title="编辑">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                        </button>
                        <button onclick="removeFriendLink(${index})" class="text-slate-400 hover:text-red-500 p-1" title="删除">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function editFriendLink(index) {
            const link = tempFriendLinks[index];
            if (!link) return;
            
            editingFriendLinkIndex = index;
            document.getElementById('friend-name-input').value = link.name;
            document.getElementById('friend-url-input').value = link.url;
            
            document.getElementById('add-friend-btn').innerText = '更新友链';
            document.getElementById('cancel-friend-edit-btn').classList.remove('hidden');
            
            renderSettingsFriendLinks();
        }

        function cancelEditFriendLink() {
            editingFriendLinkIndex = -1;
            document.getElementById('friend-name-input').value = '';
            document.getElementById('friend-url-input').value = '';
            
            document.getElementById('add-friend-btn').innerText = '添加友链';
            document.getElementById('cancel-friend-edit-btn').classList.add('hidden');
            
            renderSettingsFriendLinks();
        }

        function addFriendLink() {
            const nameInput = document.getElementById('friend-name-input');
            const urlInput = document.getElementById('friend-url-input');
            const name = nameInput.value.trim();
            let url = urlInput.value.trim();
            
            if (name && url) {
                // 简单补全协议
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                try {
                    new URL(url); // 验证 URL 有效性
                    
                    if (editingFriendLinkIndex > -1) {
                        tempFriendLinks[editingFriendLinkIndex] = { name, url };
                    } else {
                        tempFriendLinks.push({ name, url });
                    }
                    
                    cancelEditFriendLink();
                } catch (e) {
                    alert('请输入有效的网址 (例如: https://example.com)');
                }
            }
        }

        function removeFriendLink(index) {
            if (index === editingFriendLinkIndex) {
                cancelEditFriendLink();
            } else if (index < editingFriendLinkIndex) {
                editingFriendLinkIndex--;
            }
            
            tempFriendLinks.splice(index, 1);
            renderSettingsFriendLinks();
        }

        function renderFriendLinks(links) {
            const container = document.getElementById('friend-links-container');
            const section = document.getElementById('friend-links-section');
            if (!container || !section) return;
            
            if (!links || links.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            container.innerHTML = '';
            
            links.forEach(link => {
                try {
                    const urlObj = new URL(link.url);
                    const domain = urlObj.hostname;
                    const iconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                    
                    const card = document.createElement('a');
                    card.href = link.url;
                    card.target = '_blank';
                    card.className = 'bg-white p-3 rounded-xl border shadow-sm hover:shadow-md transition-all flex items-center gap-3 group';
                    card.innerHTML = `
                        <div class="h-10 w-10 rounded-full bg-slate-100 flex-shrink-0 overflow-hidden border border-slate-100 group-hover:border-blue-200 transition-colors">
                            <img src="${iconUrl}" alt="${link.name}" class="h-full w-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(link.name)}&background=random'">
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="font-medium text-slate-800 truncate group-hover:text-blue-600 transition-colors">${link.name}</div>
                            <div class="text-xs text-slate-500 truncate">${domain}</div>
                        </div>
                    `;
                    container.appendChild(card);
                } catch (e) {
                    console.error("Invalid friend link URL:", link.url);
                }
            });
        }

        function toggleBgInput(enabled) {
            const container = document.getElementById('bg-url-container');
            if (container) {
                if (enabled) {
                    container.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    container.classList.add('opacity-50', 'pointer-events-none');
                }
            }
        }

        async function openSettings() {
            const modal = document.getElementById('settings-modal');
            const bgInput = document.getElementById('bg-url-input');
            const useBgCheckbox = document.getElementById('use-bg-checkbox');
            const opacityInput = document.getElementById('opacity-input');
            const loginSection = document.getElementById('login-section');
            const settingsSection = document.getElementById('settings-content-section');
            
            if (modal) {
                // Check if logged in
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    if (loginSection) loginSection.classList.remove('hidden');
                    if (settingsSection) settingsSection.classList.add('hidden');
                } else {
                    if (loginSection) loginSection.classList.add('hidden');
                    if (settingsSection) settingsSection.classList.remove('hidden');
                    
                    // 每次打开时重新获取最新配置，确保同步
                    try {
                        const response = await fetch('/api/config');
                        if (response.ok) {
                            currentConfig = await response.json();
                        }
                    } catch (err) {
                        console.error("Error refreshing config on open:", err);
                    }
                    
                    if (bgInput) bgInput.value = currentConfig.backgroundImage || '';
                    if (useBgCheckbox) {
                        const useBg = currentConfig.useBackgroundImage === false ? false : true;
                        useBgCheckbox.checked = useBg;
                        toggleBgInput(useBg);
                    }
                    if (opacityInput) {
                        const val = currentConfig.cardOpacity !== undefined ? currentConfig.cardOpacity : 1.0;
                        opacityInput.value = val;
                        updateOpacityLabel(val);
                    }
                    tempFriendLinks = JSON.parse(JSON.stringify(currentConfig.friendLinks || []));
                    cancelEditFriendLink();
                }
                modal.classList.remove('hidden');
            }
        }

        async function login() {
            const passwordInput = document.getElementById('admin-password-input');
            const password = passwordInput.value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    localStorage.setItem('admin_token', result.token);
                    await openSettings(); // Refresh view
                } else {
                    alert('Invalid password');
                }
            } catch (err) {
                console.error("Login error:", err);
                alert('Login failed');
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
            } catch (err) {
                console.error("Logout error:", err);
            }
            localStorage.removeItem('admin_token');
            await openSettings(); // Refresh view
        }

        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function saveSettings() {
            const bgInput = document.getElementById('bg-url-input');
            const useBgCheckbox = document.getElementById('use-bg-checkbox');
            const opacityInput = document.getElementById('opacity-input');
            const token = localStorage.getItem('admin_token');
            
            if (!bgInput || !useBgCheckbox || !opacityInput || !token) return;

            const newBgUrl = bgInput.value.trim();
            const useBg = useBgCheckbox.checked;
            const newOpacity = parseFloat(opacityInput.value);
            console.log('Saving settings, useBg checkbox value:', useBg);
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        backgroundImage: newBgUrl,
                        useBackgroundImage: useBg,
                        cardOpacity: newOpacity,
                        friendLinks: tempFriendLinks
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    currentConfig = result.config; // Update local config
                    applyBackground(newBgUrl, useBg); // Apply immediately
                    applyOpacity(newOpacity);
                    renderFriendLinks(currentConfig.friendLinks);
                    closeSettings();
                } else if (response.status === 401) {
                    alert('Session expired or unauthorized. Please login again.');
                    logout();
                } else {
                    alert('Failed to save settings');
                }
            } catch (err) {
                console.error("Error saving settings:", err);
                alert('Error saving settings');
            }
        }

        fetchConfig();

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="flex items-center justify-between">
            <div>
                <h1 id="page-header" class="text-3xl font-bold tracking-tight text-slate-900">AcoFork 的 EdgeOne 监控大屏</h1>
                <p class="text-muted-foreground mt-1 simple-mode-hidden">EdgeOne 站点流量与请求量分析</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="simple-mode-btn" onclick="toggleSimpleMode()" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="切换简洁模式">
                    <!-- Icon will be inserted by JS -->
                </button>
                <button onclick="openSettings()" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="设置">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <h2 class="text-lg font-semibold">设置</h2>
                    <button onclick="closeSettings()" class="text-slate-500 hover:text-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>

                <div class="overflow-y-auto flex-1 pr-2 custom-scrollbar">
                    <!-- Login Section -->
                    <div id="login-section" class="space-y-4">
                        <p class="text-sm text-slate-600">请输入管理员密码以修改设置。</p>
                        <div>
                            <label for="admin-password-input" class="block text-sm font-medium text-slate-700 mb-1">密码</label>
                            <input type="password" id="admin-password-input" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入密码...">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="closeSettings()" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200">取消</button>
                            <button onclick="login()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">登录</button>
                        </div>
                    </div>

                    <!-- Settings Content (hidden until login) -->
                    <div id="settings-content-section" class="space-y-4 hidden">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="use-bg-checkbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" onchange="toggleBgInput(this.checked)">
                            <label for="use-bg-checkbox" class="text-sm font-medium text-slate-700">使用背景图片</label>
                        </div>
                        <div id="bg-url-container">
                            <label for="bg-url-input" class="block text-sm font-medium text-slate-700 mb-1">背景图片 URL</label>
                            <input type="text" id="bg-url-input" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入图片 URL...">
                        </div>
                        <div>
                            <label for="opacity-input" class="block text-sm font-medium text-slate-700 mb-1">卡片透明度：<span id="opacity-value">1.0</span></label>
                            <input type="range" id="opacity-input" min="0" max="1" step="0.1" value="1.0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateOpacityLabel(this.value)">
                        </div>
                        
                        <!-- Friend Links Management -->
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-slate-700 mb-2">友情链接</label>
                            <div id="friend-links-settings-list" class="space-y-2 mb-3 max-h-32 overflow-y-auto pr-1">
                                <!-- Friend links will be listed here -->
                            </div>
                            <div class="flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <input type="text" id="friend-name-input" class="flex-1 rounded-md border border-slate-300 px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="名称">
                                    <input type="text" id="friend-url-input" class="flex-[2] rounded-md border border-slate-300 px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="链接">
                                </div>
                                <div class="flex gap-2">
                                    <button id="add-friend-btn" onclick="addFriendLink()" class="flex-1 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">添加友链</button>
                                    <button id="cancel-friend-edit-btn" onclick="cancelEditFriendLink()" class="hidden flex-1 py-1.5 bg-slate-200 text-slate-700 text-sm rounded hover:bg-slate-300 transition-colors">取消</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t mt-4">
                            <button onclick="logout()" class="text-xs text-red-600 hover:underline">退出登录</button>
                            <div class="flex gap-2">
                                <button onclick="closeSettings()" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200">取消</button>
                                <button onclick="saveSettings()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">保存修改</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Controls -->
        <div class="flex flex-wrap items-center gap-4 bg-white p-4 rounded-xl border shadow-sm no-hover">
            <div class="flex items-center space-x-2">
                <label for="timeRange" class="text-sm font-medium">时间范围:</label>
                <select id="timeRange" onchange="refreshData()" class="h-9 w-[180px] rounded-md border border-slate-200 bg-white px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-slate-900">
                    <option value="1h">近 1 小时</option>
                    <option value="3h">近 3 小时</option>
                    <option value="6h">近 6 小时</option>
                    <option value="12h">近 12 小时</option>
                    <option value="24h" selected>近 24 小时</option>
                    <option value="today">当天</option>
                    <option value="3d">近 3 天</option>
                    <option value="7d">近 7 天</option>
                    <option value="15d">近 15 天</option>
                    <option value="31d">近 31 天</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="interval" class="text-sm font-medium">粒度:</label>
                <select id="interval" onchange="refreshData()" class="h-9 w-[180px] rounded-md border border-slate-200 bg-white px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-slate-900">
                    <option value="auto" selected>自动</option>
                    <option value="min">1 分钟</option>
                    <option value="5min">5 分钟</option>
                    <option value="hour">1 小时</option>
                    <option value="day">1 天</option>
                </select>
            </div>
            <!-- <button onclick="refreshData()" class="h-9 px-4 py-2 bg-slate-900 text-white hover:bg-slate-900/90 inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-slate-950 shadow">
                刷新
            </button> -->
        </div>

        <!-- Main Content -->
        <div class="space-y-8">

            <!-- Section 1: Traffic (流量) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2 simple-mode-hidden">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    流量分析 (Traffic)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Total Traffic Card -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">总流量 (Total)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_flux">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">访问总流量</p>
                        </div>
                    </div>
                    <!-- Client Request Traffic -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">客户端请求流量 (In)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inFlux">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">客户端请求流量</p>
                        </div>
                    </div>
                    <!-- EdgeOne Response Traffic -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">响应流量 (Out)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outFlux">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne 响应流量</p>
                        </div>
                    </div>
                </div>
                <!-- Traffic Chart -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">流量趋势</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_traffic" class="w-full h-[350px]"></div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Bandwidth (带宽) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2 simple-mode-hidden">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    带宽分析 (Bandwidth)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Total Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">总带宽峰值 (Total)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_bandwidth">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">访问总带宽峰值</p>
                        </div>
                    </div>
                    <!-- In Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">请求带宽峰值 (In)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inBandwidth">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">客户端请求带宽峰值</p>
                        </div>
                    </div>
                    <!-- Out Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">响应带宽峰值 (Out)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outBandwidth">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne 响应带宽峰值</p>
                        </div>
                    </div>
                </div>
                <!-- Bandwidth Chart -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">带宽趋势</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_bandwidth" class="w-full h-[350px]"></div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Origin Pull Analysis (回源分析) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2 simple-mode-hidden">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    回源分析 (Origin Pull Analysis)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Origin Out Flux -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">回源请求流量</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outFlux_hy">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne 节点至源站</p>
                        </div>
                    </div>
                    <!-- Origin Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">回源请求数</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_request_hy">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne 节点至源站</p>
                        </div>
                    </div>
                    <!-- Origin Out Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">回源请求带宽峰值</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outBandwidth_hy">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne 节点至源站</p>
                        </div>
                    </div>
                </div>
                <!-- Origin Bandwidth Cards -->
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Origin In Flux -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">回源响应流量</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inFlux_hy">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">源站至 EdgeOne 节点</p>
                        </div>
                    </div>
                    <!-- Origin In Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">回源响应带宽峰值</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inBandwidth_hy">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">源站至 EdgeOne 节点</p>
                        </div>
                    </div>
                </div>
                
                <!-- Origin Pull Chart -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">回源趋势</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_origin_pull" class="w-full h-[350px]"></div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Requests & Performance (请求与性能) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2 simple-mode-hidden">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    请求与性能 (Requests & Performance)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Total Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">总请求数</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_request">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">总请求次数</p>
                        </div>
                    </div>
                    <!-- Avg Response Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">平均响应耗时</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_avgResponseTime">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">L7 访问平均响应耗时 (ms)</p>
                        </div>
                    </div>
                    <!-- Avg First Byte Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">平均首字节耗时</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_avgFirstByteResponseTime">加载中...</div>
                            <p class="text-xs text-muted-foreground mt-1">L7 访问平均首字节响应耗时 (ms)</p>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Requests Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">请求数趋势</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_requests" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                    <!-- Performance Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">响应耗时趋势</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_performance" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Top Analysis (TOP 分析) -->
            <div class="space-y-4 simple-mode-hidden">
                <h2 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    TOP 分析 (Top Analysis)
                </h2>
                <div class="grid gap-4 md:grid-cols-2">
                    <!-- Country -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">国家/地区流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_country" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">国家/地区请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_country" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Province -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">国内省份流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_province" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">国内省份请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_province" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Status Code -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">状态码流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_status_code" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">状态码请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_status_code" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Domain -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">域名流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_domain" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">域名请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_domain" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- URL -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">URL 流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_url" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">URL 请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_url" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Resource Type -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">资源类型流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_resource_type" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">资源类型请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_resource_type" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Client IP -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">客户端IP流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_sip" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">客户端IP请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_sip" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Referer -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">Referer 流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_referer" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">Referer 请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_referer" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Device Type -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">设备类型流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua_device" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">设备类型请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua_device" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Browser -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">浏览器流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua_browser" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">浏览器请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua_browser" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- OS -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">操作系统流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua_os" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">操作系统请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua_os" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- User Agent -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">User Agent 流量排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">User Agent 请求数排行</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Friend Links -->
        <div id="friend-links-section" class="space-y-4 hidden">
            <h2 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.826a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.103-1.103"></path></svg>
                友链 (Links)
            </h2>
            <div id="friend-links-container" class="grid gap-4 grid-cols-2 md:grid-cols-4 lg:grid-cols-6">
                <!-- Friend links will be rendered here -->
            </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-center items-center pt-8 pb-4 text-sm text-muted-foreground">
            Powered By <a href="https://github.com/afoim" target="_blank" class="ml-1 font-medium underline underline-offset-4 hover:text-primary">afoim</a>
        </div>

    </div>

    <script>
        // ECharts instance variables
        let chartTraffic = null;
        let chartBandwidth = null;
        let chartRequests = null;
        let chartPerformance = null;
        let chartOriginPull = null;
        let chartTopCountry = null;
        let chartTopProvince = null;
        let chartTopStatusCode = null;
        let chartTopDomain = null;
        let chartTopUrl = null;
        let chartTopResourceType = null;
        let chartTopSip = null;
        let chartTopReferer = null;
        let chartTopUaDevice = null;
        let chartTopUaBrowser = null;
        let chartTopUaOs = null;
        let chartTopUa = null;
        let chartTopRequestCountry = null;
        let chartTopRequestProvince = null;
        let chartTopRequestStatusCode = null;
        let chartTopRequestDomain = null;
        let chartTopRequestUrl = null;
        let chartTopRequestResourceType = null;
        let chartTopRequestSip = null;
        let chartTopRequestReferer = null;
        let chartTopRequestUaDevice = null;
        let chartTopRequestUaBrowser = null;
        let chartTopRequestUaOs = null;
        let chartTopRequestUa = null;

        const provinceMap = {
            '22': '北京', '86': '内蒙古', '146': '山西', '1069': '河北', '1177': '天津',
            '119': '宁夏', '152': '陕西', '1208': '甘肃', '1467': '青海', '1468': '新疆',
            '145': '黑龙江', '1445': '吉林', '1464': '辽宁', '2': '福建', '120': '江苏',
            '121': '安徽', '122': '山东', '1050': '上海', '1442': '浙江', '182': '河南',
            '1135': '湖北', '1465': '江西', '1466': '湖南', '118': '贵州', '153': '云南',
            '1051': '重庆', '1068': '四川', '1155': '西藏', '4': '广东', '173': '广西',
            '1441': '海南', '0': '其他', '1': '港澳台', '-1': '境外'
        };

        const countryMap = {
            'CN': '中国大陆', 'AF': '阿富汗', 'MV': '马尔代夫', 'AM': '亚美尼亚', 'MN': '蒙古', 'AZ': '阿塞拜疆',
            'MM': '缅甸', 'BH': '巴林', 'NP': '尼泊尔', 'BD': '孟加拉', 'KP': '朝鲜',
            'BT': '不丹', 'OM': '阿曼', 'IO': '英属印度洋领地', 'PK': '巴基斯坦', 'KH': '柬埔寨',
            'PS': '巴勒斯坦', 'CX': '圣诞岛', 'PH': '菲律宾', 'HK': '中国香港', 'QA': '卡塔尔',
            'IN': '印度', 'SA': '沙特阿拉伯', 'ID': '印度尼西亚', 'SG': '新加坡', 'IR': '伊朗',
            'KR': '韩国', 'IQ': '伊拉克', 'LK': '斯里兰卡', 'IL': '以色列', 'SY': '叙利亚',
            'JP': '日本', 'TW': '中国台湾', 'JO': '约旦', 'TJ': '塔吉克斯坦', 'KZ': '哈萨克斯坦',
            'TH': '泰国', 'KW': '科威特', 'TM': '土库曼斯坦', 'KG': '吉尔吉斯斯坦', 'AE': '阿联酋',
            'LA': '老挝', 'UZ': '乌兹别克斯坦', 'LB': '黎巴嫩', 'VN': '越南', 'MO': '中国澳门',
            'YE': '也门', 'MY': '马来西亚', 'TR': '土耳其', 'AX': '奥兰群岛', 'IT': '意大利',
            'AL': '阿尔巴尼亚', 'JE': '泽西岛', 'AD': '安道尔', 'LT': '立陶宛', 'AT': '奥地利',
            'LU': '卢森堡', 'BY': '白俄罗斯', 'MK': '马其顿', 'BE': '比利时', 'MT': '马耳他',
            'BA': '波黑', 'MD': '摩尔多瓦', 'BG': '保加利亚', 'MC': '摩纳哥', 'BQ': '荷兰加勒比区',
            'ME': '黑山', 'HR': '克罗地亚', 'NL': '荷兰', 'CZ': '捷克', 'NO': '挪威',
            'DK': '丹麦', 'PL': '波兰', 'EE': '爱沙尼亚', 'PT': '葡萄牙', 'FO': '法罗群岛',
            'RO': '罗马尼亚', 'FI': '芬兰', 'RU': '俄罗斯', 'FR': '法国', 'SM': '圣马力诺',
            'DE': '德国', 'RS': '塞尔维亚', 'GI': '直布罗陀', 'SX': '荷属圣马丁', 'GR': '希腊',
            'SK': '斯洛伐克', 'GG': '根西岛', 'ES': '西班牙', 'HU': '匈牙利', 'SE': '瑞典',
            'IS': '冰岛', 'CH': '瑞士', 'IE': '爱尔兰', 'UA': '乌克兰', 'IM': '马恩岛',
            'GB': '英国', 'DZ': '阿尔及利亚', 'ML': '马里', 'AO': '安哥拉', 'MR': '毛里塔尼亚',
            'BJ': '贝宁', 'MU': '毛里求斯', 'BW': '博茨瓦纳', 'YT': '马约特', 'BF': '布基纳法索',
            'MA': '摩洛哥', 'BI': '布隆迪', 'MZ': '莫桑比克', 'CM': '喀麦隆', 'NA': '纳米比亚',
            'CV': '佛得角', 'NE': '尼日尔', 'CF': '中非', 'NG': '尼日利亚', 'TD': '乍得',
            'RW': '卢旺达', 'KM': '科摩罗', 'SH': '圣赫勒拿', 'DJ': '吉布提', 'ST': '圣多美和普林西比',
            'EG': '埃及', 'SN': '塞内加尔', 'GQ': '赤道几内亚', 'SC': '塞舌尔', 'ER': '厄立特里亚',
            'SL': '塞拉利昂', 'ET': '埃塞俄比亚', 'SO': '索马里', 'GA': '加蓬', 'ZA': '南非',
            'GM': '冈比亚', 'SS': '南苏丹', 'GH': '加纳', 'SD': '苏丹', 'GN': '几内亚',
            'SZ': '斯威士兰', 'GW': '几内亚比绍', 'TZ': '坦桑尼亚', 'KE': '肯尼亚', 'TG': '多哥',
            'LS': '莱索托', 'TN': '突尼斯', 'LR': '利比里亚', 'UG': '乌干达', 'LY': '利比亚',
            'EH': '西撒哈拉', 'MG': '马达加斯加', 'ZM': '赞比亚', 'MW': '马拉维', 'ZW': '津巴布韦',
            'CD': '刚果民主共和国', 'CG': '刚果共和国', 'CI': '科特迪瓦', 'AU': '澳大利亚', 'NF': '诺福克岛',
            'CK': '库克群岛', 'MP': '北马里亚纳群岛', 'TL': '东帝汶', 'PW': '帕劳', 'GU': '关岛',
            'PG': '巴布亚新几内亚', 'KI': '基里巴斯', 'SB': '所罗门群岛', 'MH': '马绍尔群岛', 'TO': '汤加',
            'NR': '瑙鲁', 'TV': '图瓦卢', 'NZ': '新西兰', 'AI': '安圭拉', 'HT': '海地',
            'AG': '安提瓜和巴布达', 'HN': '洪都拉斯', 'AW': '阿鲁巴', 'JM': '牙买加', 'BS': '巴哈马',
            'MX': '墨西哥', 'BB': '巴巴多斯', 'MS': '蒙塞拉特岛', 'BM': '百慕大', 'NI': '尼加拉瓜',
            'CA': '加拿大', 'PA': '巴拿马', 'KY': '开曼群岛', 'PR': '波多黎各', 'CR': '哥斯达黎加',
            'KN': '圣基茨和尼维斯', 'CU': '古巴', 'LC': '圣卢西亚', 'CW': '库拉索', 'MF': '法属圣马丁',
            'SV': '萨尔瓦多', 'TT': '特立尼达和多巴哥', 'GL': '格陵兰岛', 'TC': '特克斯和凯科斯群岛',
            'GD': '格林纳达', 'US': '美国', 'GT': '危地马拉', 'AR': '阿根廷', 'GY': '圭亚那',
            'BO': '玻利维亚', 'PY': '巴拉圭', 'BR': '巴西', 'PE': '秘鲁', 'CL': '智利',
            'SR': '苏里南', 'CO': '哥伦比亚', 'UY': '乌拉圭', 'EC': '厄瓜多尔', 'VE': '委内瑞拉',
            'GF': '法属圭亚那', 'Antarctica': '南极洲'
        };

        const metricsConfig = {
            traffic: ['l7Flow_flux', 'l7Flow_inFlux', 'l7Flow_outFlux'],
            bandwidth: ['l7Flow_bandwidth', 'l7Flow_inBandwidth', 'l7Flow_outBandwidth'],
            originPull: ['l7Flow_outFlux_hy', 'l7Flow_inFlux_hy', 'l7Flow_outBandwidth_hy', 'l7Flow_inBandwidth_hy', 'l7Flow_request_hy'],
            requests: ['l7Flow_request'],
            performance: ['l7Flow_avgResponseTime', 'l7Flow_avgFirstByteResponseTime'],
            topAnalysis: ['l7Flow_outFlux_country', 'l7Flow_outFlux_province', 'l7Flow_outFlux_statusCode', 'l7Flow_outFlux_domain', 'l7Flow_outFlux_url', 'l7Flow_outFlux_resourceType', 'l7Flow_outFlux_sip', 'l7Flow_outFlux_referers', 'l7Flow_outFlux_ua_device', 'l7Flow_outFlux_ua_browser', 'l7Flow_outFlux_ua_os', 'l7Flow_outFlux_ua', 'l7Flow_request_country', 'l7Flow_request_province', 'l7Flow_request_statusCode', 'l7Flow_request_domain', 'l7Flow_request_url', 'l7Flow_request_resourceType', 'l7Flow_request_sip', 'l7Flow_request_referers', 'l7Flow_request_ua_device', 'l7Flow_request_ua_browser', 'l7Flow_request_ua_os', 'l7Flow_request_ua']
        };

        const metricLabels = {
            'l7Flow_flux': '总流量',
            'l7Flow_inFlux': '客户端请求流量',
            'l7Flow_outFlux': '响应流量',
            'l7Flow_bandwidth': '总带宽',
            'l7Flow_inBandwidth': '请求带宽',
            'l7Flow_outBandwidth': '响应带宽',
            'l7Flow_outFlux_hy': '回源请求流量',
            'l7Flow_inFlux_hy': '回源响应流量',
            'l7Flow_outBandwidth_hy': '回源请求带宽',
            'l7Flow_inBandwidth_hy': '回源响应带宽',
            'l7Flow_request_hy': '回源请求数',
            'l7Flow_request': '请求数',
            'l7Flow_avgResponseTime': '平均响应耗时',
            'l7Flow_avgFirstByteResponseTime': '平均首字节耗时',
            'l7Flow_outFlux_country': '国家/地区流量',
            'l7Flow_outFlux_province': '国内省份流量',
            'l7Flow_outFlux_statusCode': '状态码流量',
            'l7Flow_outFlux_domain': '域名流量',
            'l7Flow_outFlux_url': 'URL 流量',
            'l7Flow_outFlux_resourceType': '资源类型流量',
            'l7Flow_outFlux_sip': '客户端IP流量',
            'l7Flow_outFlux_referers': 'Referer 流量',
            'l7Flow_outFlux_ua_device': '设备类型流量',
            'l7Flow_outFlux_ua_browser': '浏览器流量',
            'l7Flow_outFlux_ua_os': '操作系统流量',
            'l7Flow_outFlux_ua': 'User Agent 流量',
            'l7Flow_request_country': '国家/地区请求数',
            'l7Flow_request_province': '国内省份请求数',
            'l7Flow_request_statusCode': '状态码请求数',
            'l7Flow_request_domain': '域名请求数',
            'l7Flow_request_url': 'URL 请求数',
            'l7Flow_request_resourceType': '资源类型请求数',
            'l7Flow_request_sip': '客户端IP请求数',
            'l7Flow_request_referers': 'Referer 请求数',
            'l7Flow_request_ua_device': '设备类型请求数',
            'l7Flow_request_ua_browser': '浏览器请求数',
            'l7Flow_request_ua_os': '操作系统请求数',
            'l7Flow_request_ua': 'User Agent 请求数'
        };

        const metricColors = {
            'l7Flow_flux': '#3b82f6', // blue
            'l7Flow_inFlux': '#f59e0b', // amber
            'l7Flow_outFlux': '#10b981', // green
            'l7Flow_bandwidth': '#8b5cf6', // purple
            'l7Flow_inBandwidth': '#ec4899', // pink
            'l7Flow_outBandwidth': '#06b6d4', // cyan
            'l7Flow_outFlux_hy': '#3b82f6', // blue
            'l7Flow_inFlux_hy': '#10b981', // green
            'l7Flow_outBandwidth_hy': '#8b5cf6', // purple
            'l7Flow_inBandwidth_hy': '#ec4899', // pink
            'l7Flow_request_hy': '#f43f5e', // rose
            'l7Flow_request': '#f43f5e', // rose
            'l7Flow_avgResponseTime': '#ef4444', // red
            'l7Flow_avgFirstByteResponseTime': '#f97316', // orange
            'l7Flow_outFlux_country': '#3b82f6', // blue
            'l7Flow_outFlux_province': '#f59e0b', // amber
            'l7Flow_outFlux_statusCode': '#8b5cf6', // purple
            'l7Flow_outFlux_domain': '#06b6d4', // cyan
            'l7Flow_outFlux_url': '#10b981', // green
            'l7Flow_outFlux_resourceType': '#f59e0b', // amber
            'l7Flow_outFlux_sip': '#ef4444', // red
            'l7Flow_outFlux_referers': '#8b5cf6', // purple
            'l7Flow_outFlux_ua_device': '#06b6d4', // cyan
            'l7Flow_outFlux_ua_browser': '#f59e0b', // amber
            'l7Flow_outFlux_ua_os': '#10b981', // green
            'l7Flow_outFlux_ua': '#8b5cf6', // purple
            'l7Flow_request_country': '#3b82f6', // blue
            'l7Flow_request_province': '#f59e0b', // amber
            'l7Flow_request_statusCode': '#8b5cf6', // purple
            'l7Flow_request_domain': '#06b6d4', // cyan
            'l7Flow_request_url': '#10b981', // green
            'l7Flow_request_resourceType': '#f59e0b', // amber
            'l7Flow_request_sip': '#8b5cf6', // purple
            'l7Flow_request_referers': '#ec4899', // pink
            'l7Flow_request_ua_device': '#06b6d4', // cyan
            'l7Flow_request_ua_browser': '#10b981', // green
            'l7Flow_request_ua_os': '#f59e0b', // amber
            'l7Flow_request_ua': '#8b5cf6' // purple
        };

        function formatDate(date) {
            return date.toISOString().slice(0, 19) + 'Z';
        }

        function calculateTimeRange() {
            const range = document.getElementById('timeRange').value;
            const now = new Date();
            const endTime = new Date(now);
            let startTime;

            switch(range) {
                case '1h': startTime = new Date(now.getTime() - 1 * 60 * 60 * 1000); break;
                case '3h': startTime = new Date(now.getTime() - 3 * 60 * 60 * 1000); break;
                case '6h': startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000); break;
                case '12h': startTime = new Date(now.getTime() - 12 * 60 * 60 * 1000); break;
                case '24h': startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000); break;
                case 'today': 
                    startTime = new Date(now);
                    startTime.setHours(0, 0, 0, 0);
                    break;
                case '3d': startTime = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000); break;
                case '7d': startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case '15d': startTime = new Date(now.getTime() - 15 * 24 * 60 * 60 * 1000); break;
                case '31d': startTime = new Date(now.getTime() - 31 * 24 * 60 * 60 * 1000); break;
                default: startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            }

            return {
                startTime: formatDate(startTime),
                endTime: formatDate(endTime)
            };
        }

        async function fetchData(metric) {
            try {
                const { startTime, endTime } = calculateTimeRange();
                const interval = document.getElementById('interval').value;
                
                let url = `/api/traffic?metric=${metric}&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
                if (interval && interval !== 'auto') {
                    url += `&interval=${interval}`;
                }

                const response = await fetch(url);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                return result;
            } catch (err) {
                console.error(`Error fetching ${metric}:`, err);
                return null;
            }
        }

        function processData(result) {
            // Check for Top Data Structure (DescribeTopL7AnalysisData)
            // It returns Data[0].DetailData (Array of Key/Value)
            if (result?.Data?.[0]?.DetailData) {
                 return {
                     type: 'top',
                     data: result.Data[0].DetailData
                 };
            }

            // DescribeTimingL7AnalysisData returns 'Data'
            // DescribeTimingL7OriginPullData returns 'TimingDataRecords'
            const dataList = result?.Data || result?.TimingDataRecords || [];
            if (dataList.length === 0) return { timeData: [], valueData: [], sum: 0, max: 0, avg: 0, type: 'time' };

            const typeValue = dataList[0]?.TypeValue?.[0];
            const details = typeValue?.Detail || [];
            const sum = typeValue?.Sum || 0;
            const max = typeValue?.Max || 0;
            const avg = typeValue?.Avg || 0;

            const timeData = [];
            const valueData = [];

            // Context for formatting
            const range = document.getElementById('timeRange')?.value || '24h';
            const interval = document.getElementById('interval')?.value || 'auto';
            const longRanges = ['3d', '7d', '15d', '31d'];
            
            // Auto-detect if interval is effectively 'day'
            let isDayInterval = interval === 'day';
            if (interval === 'auto' && details.length > 1) {
                const diff = details[1].Timestamp - details[0].Timestamp;
                // If interval is >= 23 hours (allow some slack), treat as day
                if (diff >= 82800) isDayInterval = true;
            }
            // If auto and range is 31d/15d, it usually defaults to day
            if (interval === 'auto' && ['15d', '31d'].includes(range)) {
                // Check if we have few points (e.g. < 32 for 31d), likely day
                if (details.length <= 32) isDayInterval = true;
            }

            details.forEach(item => {
                const date = new Date(item.Timestamp * 1000);
                let label;

                if (isDayInterval) {
                    // Show YYYY-MM-DD
                    label = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                } else if (longRanges.includes(range)) {
                    // Show MM-DD HH:mm for long ranges with finer granularity
                    label = `${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    // Show HH:mm for short ranges
                    label = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }

                timeData.push(label);
                valueData.push(item.Value);
            });

            return { timeData, valueData, sum, max, avg, type: 'time' };
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatBps(bps) {
            if (bps >= 1024 * 1024 * 1024) {
                return (bps / (1024 * 1024 * 1024)).toFixed(2) + ' Gbps';
            } else if (bps >= 1024 * 1024) {
                return (bps / (1024 * 1024)).toFixed(2) + ' Mbps';
            } else if (bps >= 1024) {
                return (bps / 1024).toFixed(2) + ' Kbps';
            } else {
                return bps + ' bps';
            }
        }

        async function initDashboard() {
            // Initialize charts
            chartTraffic = echarts.init(document.getElementById('chart_traffic'));
            chartBandwidth = echarts.init(document.getElementById('chart_bandwidth'));
            chartRequests = echarts.init(document.getElementById('chart_requests'));
            chartPerformance = echarts.init(document.getElementById('chart_performance'));
            chartOriginPull = echarts.init(document.getElementById('chart_origin_pull'));
            chartTopCountry = echarts.init(document.getElementById('chart_top_country'));
            chartTopProvince = echarts.init(document.getElementById('chart_top_province'));
            chartTopStatusCode = echarts.init(document.getElementById('chart_top_status_code'));
            chartTopDomain = echarts.init(document.getElementById('chart_top_domain'));
            chartTopUrl = echarts.init(document.getElementById('chart_top_url'));
            chartTopResourceType = echarts.init(document.getElementById('chart_top_resource_type'));
            chartTopSip = echarts.init(document.getElementById('chart_top_sip'));
            chartTopReferer = echarts.init(document.getElementById('chart_top_referer'));
            chartTopUaDevice = echarts.init(document.getElementById('chart_top_ua_device'));
            chartTopUaBrowser = echarts.init(document.getElementById('chart_top_ua_browser'));
            chartTopUaOs = echarts.init(document.getElementById('chart_top_ua_os'));
            chartTopUa = echarts.init(document.getElementById('chart_top_ua'));
            chartTopRequestCountry = echarts.init(document.getElementById('chart_top_request_country'));
            chartTopRequestProvince = echarts.init(document.getElementById('chart_top_request_province'));
            chartTopRequestStatusCode = echarts.init(document.getElementById('chart_top_request_status_code'));
            chartTopRequestDomain = echarts.init(document.getElementById('chart_top_request_domain'));
            chartTopRequestUrl = echarts.init(document.getElementById('chart_top_request_url'));
            chartTopRequestResourceType = echarts.init(document.getElementById('chart_top_request_resource_type'));
            chartTopRequestSip = echarts.init(document.getElementById('chart_top_request_sip'));
            chartTopRequestReferer = echarts.init(document.getElementById('chart_top_request_referer'));
            chartTopRequestUaDevice = echarts.init(document.getElementById('chart_top_request_ua_device'));
            chartTopRequestUaBrowser = echarts.init(document.getElementById('chart_top_request_ua_browser'));
            chartTopRequestUaOs = echarts.init(document.getElementById('chart_top_request_ua_os'));
            chartTopRequestUa = echarts.init(document.getElementById('chart_top_request_ua'));

            await refreshData();
        }

        async function refreshData() {
            // Show loading
            document.querySelectorAll('[id^="kpi_"]').forEach(el => el.innerText = '加载中...');

            // Fetch all metrics
            const allMetrics = [
                ...metricsConfig.traffic,
                ...metricsConfig.bandwidth,
                ...metricsConfig.originPull,
                ...metricsConfig.requests,
                ...metricsConfig.performance,
                ...metricsConfig.topAnalysis
            ];

            const results = {};
            // Parallel fetch
            await Promise.all(allMetrics.map(async (metric) => {
                const res = await fetchData(metric);
                if (res) {
                    results[metric] = processData(res);
                }
            }));

            // Update UI
            updateTrafficSection(results);
            updateBandwidthSection(results);
            updateOriginPullSection(results);
            updateRequestsSection(results);
            updatePerformanceSection(results);
            updateTopAnalysisSection(results);
        }

        function updateTrafficSection(results) {
            const metrics = metricsConfig.traffic;
            const series = [];
            let timeData = [];

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                document.getElementById(`kpi_${metric}`).innerText = formatBytes(data.sum);

                if (timeData.length === 0) timeData = data.timeData;

                // Chart Data (MB)
                const valueDataMB = data.valueData.map(v => (v / (1024 * 1024)).toFixed(2));
                
                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: valueDataMB,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.1 }
                });
            });

            const option = {
                tooltip: { trigger: 'axis', formatter: (params) => {
                    let res = params[0].axisValue + '<br/>';
                    params.forEach(param => {
                        res += `${param.marker}${param.seriesName}: ${param.value} MB<br/>`;
                    });
                    return res;
                }},
                legend: { data: metrics.map(m => metricLabels[m]), bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: timeData },
                yAxis: { type: 'value', name: 'MB' },
                series: series
            };
            chartTraffic.setOption(option);
        }

        function updateBandwidthSection(results) {
            const metrics = metricsConfig.bandwidth;
            const series = [];
            let timeData = [];

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI (Max/Peak)
                document.getElementById(`kpi_${metric}`).innerText = formatBps(data.max);

                if (timeData.length === 0) timeData = data.timeData;

                // Chart Data (Mbps)
                const valueDataMbps = data.valueData.map(v => (v / (1024 * 1024)).toFixed(2));
                
                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: valueDataMbps,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.1 }
                });
            });

            const option = {
                tooltip: { trigger: 'axis', formatter: (params) => {
                    let res = params[0].axisValue + '<br/>';
                    params.forEach(param => {
                        res += `${param.marker}${param.seriesName}: ${param.value} Mbps<br/>`;
                    });
                    return res;
                }},
                legend: { data: metrics.map(m => metricLabels[m]), bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: timeData },
                yAxis: { type: 'value', name: 'Mbps' },
                series: series
            };
            chartBandwidth.setOption(option);
        }

        function updateRequestsSection(results) {
            const metrics = metricsConfig.requests;
            const series = [];
            let timeData = [];

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                document.getElementById(`kpi_${metric}`).innerText = data.sum.toLocaleString();

                if (timeData.length === 0) timeData = data.timeData;

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: data.valueData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.2 }
                });
            });

            const option = {
                tooltip: { trigger: 'axis' },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: timeData },
                yAxis: { type: 'value' },
                series: series
            };
            chartRequests.setOption(option);
        }

        function updateOriginPullSection(results) {
            const metrics = metricsConfig.originPull;
            const series = [];
            let timeData = [];

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                const kpiEl = document.getElementById(`kpi_${metric}`);
                if (kpiEl) {
                    if (metric.includes('Flux')) {
                         kpiEl.innerText = formatBytes(data.sum);
                    } else if (metric.includes('Bandwidth')) {
                         kpiEl.innerText = formatBps(data.max);
                    } else {
                         kpiEl.innerText = data.sum.toLocaleString();
                    }
                }

                if (timeData.length === 0) timeData = data.timeData;

                let chartData = [];
                // Normalize data for chart
                if (metric.includes('Flux')) {
                    // Bytes -> MB
                    chartData = data.valueData.map(v => (v / (1024 * 1024)).toFixed(2));
                } else if (metric.includes('Bandwidth')) {
                    // bps -> Mbps
                    chartData = data.valueData.map(v => (v / (1024 * 1024)).toFixed(2));
                } else {
                    chartData = data.valueData;
                }

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: chartData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.1 }
                });
            });

            const option = {
                tooltip: { trigger: 'axis' },
                legend: { data: metrics.map(m => metricLabels[m]), bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: timeData },
                yAxis: { type: 'value' },
                series: series
            };
            chartOriginPull.setOption(option);
        }

        function updatePerformanceSection(results) {
            const metrics = metricsConfig.performance;
            const series = [];
            let timeData = [];

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI (Avg)
                document.getElementById(`kpi_${metric}`).innerText = data.avg.toFixed(2) + ' ms';

                if (timeData.length === 0) timeData = data.timeData;

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: data.valueData,
                    itemStyle: { color: metricColors[metric] }
                });
            });

            const option = {
                tooltip: { trigger: 'axis', formatter: '{b}<br/>{a}: {c} ms' },
                legend: { data: metrics.map(m => metricLabels[m]), bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: timeData },
                yAxis: { type: 'value', name: 'ms' },
                series: series
            };
            chartPerformance.setOption(option);
        }

        function updateTopAnalysisSection(results) {
            updateTopCountryChart(results);
            updateTopProvinceChart(results);
            updateTopStatusCodeChart(results);
            updateTopDomainChart(results);
            updateTopUrlChart(results);
            updateTopResourceTypeChart(results);
            updateTopSipChart(results);
            updateTopRefererChart(results);
            updateTopUaDeviceChart(results);
            updateTopUaBrowserChart(results);
            updateTopUaOsChart(results);
            updateTopUaChart(results);
            updateTopRequestCountryChart(results);
            updateTopRequestProvinceChart(results);
            updateTopRequestStatusCodeChart(results);
            updateTopRequestDomainChart(results);
            updateTopRequestUrlChart(results);
            updateTopRequestResourceTypeChart(results);
            updateTopRequestSipChart(results);
            updateTopRequestRefererChart(results);
            updateTopRequestUaDeviceChart(results);
            updateTopRequestUaBrowserChart(results);
            updateTopRequestUaOsChart(results);
            updateTopRequestUaChart(results);
        }

        function updateTopCountryChart(results) {
            const metric = 'l7Flow_outFlux_country';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => countryMap[item.Key] || item.Key).reverse(); // Countries
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#3b82f6' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopCountry.setOption(option);
        }

        function updateTopProvinceChart(results) {
            const metric = 'l7Flow_outFlux_province';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => provinceMap[item.Key] || item.Key).reverse(); // Map ID to Province Name
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#f59e0b' }, // Amber
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopProvince.setOption(option);
        }

        function updateTopStatusCodeChart(results) {
            const metric = 'l7Flow_outFlux_statusCode';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse(); // Status Codes
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#8b5cf6' }, // Purple
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopStatusCode.setOption(option);
        }

        function updateTopDomainChart(results) {
            const metric = 'l7Flow_outFlux_domain';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse(); // Domains
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#06b6d4' }, // Cyan
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopDomain.setOption(option);
        }

        function updateTopUrlChart(results) {
            const metric = 'l7Flow_outFlux_url';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse(); // URLs
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         // Truncate long URLs in tooltip if needed, but usually full URL is better
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { 
                    type: 'category', 
                    data: yAxisData,
                    axisLabel: {
                        formatter: function (value) {
                            // Truncate long URLs in axis label
                            if (value.length > 30) {
                                return value.substring(0, 30) + '...';
                            }
                            return value;
                        }
                    }
                },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#10b981' }, // Green
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopUrl.setOption(option);
        }

        function updateTopResourceTypeChart(results) {
            const metric = 'l7Flow_outFlux_resourceType';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse(); // Resource Types
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#f59e0b' }, // Amber
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopResourceType.setOption(option);
        }

        function updateTopSipChart(results) {
            const metric = 'l7Flow_outFlux_sip';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse(); // Client IPs
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#ef4444' }, // Red
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopSip.setOption(option);
        }

        function updateTopRefererChart(results) {
            const metric = 'l7Flow_outFlux_referers';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => {
                // Clean up key: remove backticks and trim
                let key = item.Key.replace(/`/g, '').trim();
                if (!key || key === '-') return '无/直接访问';
                return key;
            }).reverse();
            
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { 
                    type: 'category', 
                    data: yAxisData,
                    axisLabel: {
                        formatter: function (value) {
                            // Truncate long URLs
                            if (value.length > 30) {
                                return value.substring(0, 30) + '...';
                            }
                            return value;
                        }
                    }
                },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#8b5cf6' }, // Purple
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopReferer.setOption(option);
        }

        function updateTopUaDeviceChart(results) {
            const metric = 'l7Flow_outFlux_ua_device';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#06b6d4' }, // Cyan
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopUaDevice.setOption(option);
        }

        function updateTopUaBrowserChart(results) {
            const metric = 'l7Flow_outFlux_ua_browser';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#f59e0b' }, // Amber
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopUaBrowser.setOption(option);
        }

        function updateTopUaOsChart(results) {
            const metric = 'l7Flow_outFlux_ua_os';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#10b981' }, // Green
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopUaOs.setOption(option);
        }

        function updateTopUaChart(results) {
            const metric = 'l7Flow_outFlux_ua';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key.substring(0, 50) + (item.Key.length > 50 ? '...' : '')).reverse(); // Truncate long UAs
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         // Find full UA string
                         const originalItem = sortedData.find((item, index) => index === (sortedData.length - 1 - param.dataIndex));
                         const fullName = originalItem ? originalItem.Key : param.name;
                         return `${fullName}<br/>${param.marker}流量: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB' },
                yAxis: { type: 'category', data: yAxisData, axisLabel: { interval: 0, width: 200, overflow: 'truncate' } },
                series: [
                    {
                        name: '流量',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#8b5cf6' }, // Purple
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopUa.setOption(option);
        }

        function updateTopRequestCountryChart(results) {
            const metric = 'l7Flow_request_country';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => countryMap[item.Key] || item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#3b82f6' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestCountry.setOption(option);
        }

        function updateTopRequestProvinceChart(results) {
            const metric = 'l7Flow_request_province';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => provinceMap[item.Key] || item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#f59e0b' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestProvince.setOption(option);
        }

        function updateTopRequestStatusCodeChart(results) {
            const metric = 'l7Flow_request_statusCode';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#8b5cf6' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestStatusCode.setOption(option);
        }

        function updateTopRequestDomainChart(results) {
            const metric = 'l7Flow_request_domain';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData, axisLabel: { interval: 0, width: 200, overflow: 'truncate' } },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#06b6d4' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestDomain.setOption(option);
        }

        function updateTopRequestUrlChart(results) {
            const metric = 'l7Flow_request_url';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData, axisLabel: { interval: 0, width: 200, overflow: 'truncate' } },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#10b981' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestUrl.setOption(option);
        }

        function updateTopRequestResourceTypeChart(results) {
            const metric = 'l7Flow_request_resourceType';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#f59e0b' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestResourceType.setOption(option);
        }

        function updateTopRequestSipChart(results) {
            const metric = 'l7Flow_request_sip';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#8b5cf6' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestSip.setOption(option);
        }

        function updateTopRequestRefererChart(results) {
            const metric = 'l7Flow_request_referers';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => {
                 let key = item.Key;
                 if (key === '-') return '直接访问';
                 // Clean up backticks and extra spaces
                 key = key.replace(/`/g, '').trim();
                 return key.substring(0, 50) + (key.length > 50 ? '...' : '');
            }).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         // Find full referer string
                         const originalItem = sortedData.find((item, index) => index === (sortedData.length - 1 - param.dataIndex));
                         let fullName = param.name;
                         if (originalItem) {
                             let key = originalItem.Key;
                             if (key === '-') fullName = '直接访问';
                             else fullName = key.replace(/`/g, '').trim();
                         }
                         return `${fullName}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData, axisLabel: { interval: 0, width: 200, overflow: 'truncate' } },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#ec4899' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestReferer.setOption(option);
        }

        function updateTopRequestUaDeviceChart(results) {
            const metric = 'l7Flow_request_ua_device';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#06b6d4' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestUaDevice.setOption(option);
        }

        function updateTopRequestUaBrowserChart(results) {
            const metric = 'l7Flow_request_ua_browser';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#10b981' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestUaBrowser.setOption(option);
        }

        function updateTopRequestUaOsChart(results) {
            const metric = 'l7Flow_request_ua_os';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#f59e0b' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestUaOs.setOption(option);
        }

        function updateTopRequestUaChart(results) {
            const metric = 'l7Flow_request_ua';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => item.Key.substring(0, 50) + (item.Key.length > 50 ? '...' : '')).reverse(); // Truncate long UAs
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         // Find full UA string
                         const originalItem = sortedData.find((item, index) => index === (sortedData.length - 1 - param.dataIndex));
                         const fullName = originalItem ? originalItem.Key : param.name;
                         return `${fullName}<br/>${param.marker}请求数: ${param.value.toLocaleString()} 次`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: '次' },
                yAxis: { type: 'category', data: yAxisData, axisLabel: { interval: 0, width: 200, overflow: 'truncate' } },
                series: [
                    {
                        name: '请求数',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#8b5cf6' },
                        label: { show: true, position: 'right' }
                    }
                ]
            };

            chartTopRequestUa.setOption(option);
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            chartTraffic && chartTraffic.resize();
            chartBandwidth && chartBandwidth.resize();
            chartRequests && chartRequests.resize();
            chartPerformance && chartPerformance.resize();
            chartOriginPull && chartOriginPull.resize();
            chartTopCountry && chartTopCountry.resize();
            chartTopProvince && chartTopProvince.resize();
            chartTopStatusCode && chartTopStatusCode.resize();
            chartTopDomain && chartTopDomain.resize();
            chartTopUrl && chartTopUrl.resize();
            chartTopResourceType && chartTopResourceType.resize();
            chartTopSip && chartTopSip.resize();
            chartTopReferer && chartTopReferer.resize();
            chartTopUaDevice && chartTopUaDevice.resize();
            chartTopUaBrowser && chartTopUaBrowser.resize();
            chartTopUaOs && chartTopUaOs.resize();
            chartTopUa && chartTopUa.resize();
            chartTopRequestCountry && chartTopRequestCountry.resize();
            chartTopRequestProvince && chartTopRequestProvince.resize();
            chartTopRequestStatusCode && chartTopRequestStatusCode.resize();
            chartTopRequestDomain && chartTopRequestDomain.resize();
            chartTopRequestUrl && chartTopRequestUrl.resize();
            chartTopRequestResourceType && chartTopRequestResourceType.resize();
            chartTopRequestSip && chartTopRequestSip.resize();
            chartTopRequestReferer && chartTopRequestReferer.resize();
            chartTopRequestUaDevice && chartTopRequestUaDevice.resize();
            chartTopRequestUaBrowser && chartTopRequestUaBrowser.resize();
            chartTopRequestUaOs && chartTopRequestUaOs.resize();
            chartTopRequestUa && chartTopRequestUa.resize();
        });

        // Start
        initDashboard();
    </script>
</body>
</html>
